<div id="capture" style="width: 1350px; margin-left: auto; margin-right: auto; margin-bottom: 0; padding-bottom: 0">
  <div style="width: 1350px; margin-left: auto; margin-right: auto; margin-bottom: 0; padding-bottom: 0">

    <div id="table-1" style="width: 1350px; margin: 0; padding: 0">
      <table style="font-size: 13px" class="table is-bordered has-text-centered">
        <thead class="has-text-centered">
        <th class="has-text-centered">原设计中的压裂段数(常规压裂)</th>
        <th class="has-text-centered">合并缩减/优化后的压裂段数("零"桥塞压裂TM)</th>
        </thead>
        <tbody>
        <tr>
          <td>
            <input id="form-data-原设计中的压裂段数" name="原设计中的压裂段数" class="only-int input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                   placeholder="请输入" value="25">
          </td>
          <td>
            <input id="form-data-合并缩减-优化后的压裂段数" name="合并缩减-优化后的压裂段数" class="only-int input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                   placeholder="请输入" value="15">
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <div id="control-panel" style="width: 1350px; margin: 0; padding: 0">
      <div class="columns" style="margin: 0; padding: 0 0 8px 0">
        <button id="btn-setting" style="margin-right: 8px" class="column button button-vertical-center is-link">
          更多参数设置
        </button>
        <button id="btn-calculate" style="margin-right: 8px" class="column button button-vertical-center is-link">计算
        </button>
        <button id="btn-capture" style="margin-right: 8px" class="column button button-vertical-center is-link">截图
        </button>
        <button id="btn-about-us" class="column button button-vertical-center is-link">联系我们</button>
      </div>
    </div>

    <div id="table-2" style="width: 1350px; margin: 0; padding: 0;display: none">
      <table style="font-size: 13px" class="table is-bordered has-text-centered">
        <thead class="has-text-centered">
        <th class="has-text-centered">更多参数</th>
        <th class="has-text-centered">值</th>
        <th class="has-text-centered">数量</th>
        </thead>
        <tbody>
        <tr>
          <td>压裂车费用</td>
          <td>
            <input id="form-data-压裂车费用-N-1" name="压裂车费用-值" class="only-num input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                   placeholder="请输入" value="0.95">
          </td>
          <td>
            <input  id="form-data-压裂车费用-N-2" name="压裂车费用-数量" class="only-int input is-small has-text-centered" style="background-color: #e3f4eb" type="text" placeholder="请输入" value="24">
          </td>
        </tr>
        <tr>
          <td>混砂车费用</td>
          <td><input id="form-data-混砂车费用-N-1" name="混砂车费用-值" class="only-num input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                     placeholder="请输入" value="0.6"></td>
          <td><input id="form-data-混砂车费用-N-2" name="混砂车费用-费用" class="only-int input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                     placeholder="请输入" value="1"></td>
        </tr>
        <tr>
          <td>仪表车</td>
          <td><input id="form-data-仪表车费用-N-1" name="仪表车费用" class="only-num input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                     placeholder="请输入" value="0.3"></td>
          <td></td>
        </tr>
        <tr>
          <td>桥射联作费用</td>
          <td><input id="form-data-桥射联作费用-N-1" name="桥射联作费用" class="only-num input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                     placeholder="请输入" value="8"></td>
          <td></td>
        </tr>
        <tr>
          <td>连油钻塞费用</td>
          <td><input id="form-data-连油钻塞费用-N-1" name="连油钻塞费用" class="only-num input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                     placeholder="请输入" value="3.1"></td>
          <td></td>
        </tr>
        <tr>
          <td>桥塞费用</td>
          <td><input id="form-data-桥塞费用-N-1" name="桥塞费用" class="only-num input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                     placeholder="请输入" value="1.1"></td>
          <td></td>
        </tr>
        <tr>
          <td>压裂施工速度</td>
          <td><input id="form-data-压裂施工速度-N-1" name="压裂施工速度" class="only-num input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                     placeholder="请输入" value="2.5"></td>
          <td></td>
        </tr>
        <tr>
          <td>桥射联作耗时</td>
          <td><input id="form-data-桥射联作平均耗时-N-1" name="桥射联作平均耗时" class="only-num input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                     placeholder="请输入" value="3"></td>
          <td></td>
        </tr>
        <tr>
          <td>桥塞遇阻,提前坐封概率</td>
          <td><input id="form-data-桥塞遇阻或提前坐封概率-N-1" name="桥塞遇阻或提前坐封概率" class="only-num input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                     placeholder="请输入" value="1"></td>
          <td></td>
        </tr>
        <tr>
          <td>射孔枪点火失败概率</td>
          <td><input id="form-data-射孔枪点火失败概率-N-1" name="射孔枪点火失败概率" class="only-num input is-small has-text-centered" style="background-color: #e3f4eb" type="text"
                     placeholder="请输入" value="1"></td>
          <td></td>
        </tr>
        </tbody>
      </table>
    </div>

    <div id="table-3" style="width: 1350px; margin: 0; padding: 0">
      <table style="font-size: 13px" class="table is-bordered has-text-centered">
        <thead class="has-text-centered">
        <th class="has-text-centered">段数减少</th>
        <th class="has-text-centered">费用减少</th>
        <th class="has-text-centered">施工时间减少</th>
        <th class="has-text-centered">桥射联作风险降低(遇阻,提前坐封,点火失败)</th>
        </thead>
        <tbody>
        <tr>
          <td id="td3-段数减少"></td>
          <td id="td3-费用减少"></td>
          <td id="td3-施工时间减少"></td>
          <td id="td3-桥射联作风险降低"></td>
        </tr>
        </tbody>
      </table>
    </div>

  </div>

  <div style="width: 1350px; margin-left: auto; margin-right: auto; margin-top: 0; padding-top: 0">
    <div id="calculatorPie"
         style="height: 450px;width: 1300px; margin-left: 50px; margin-bottom: 0; padding-bottom: 0; margin-top: 0; padding-top: 0"/>
  </div>
  <div style="width: 1350px; margin-left: auto; margin-right: auto; margin-top: 0; padding-top: 0">
    <table  id="table-4" class="table is-bordered" style="font-size: 13px; margin-top: 0; padding-top: 0">
      <thead>
      <th style="width: 180px"></th>
      <th style="width: 150px">压裂段数</th>
      <th style="width: 150px">压裂费用</th>
      <th style="width: 140px">桥射联作费用</th>
      <th style="width: 140px">连油钻塞费用</th>
      <th style="width: 150px">桥塞费用</th>
      <th style="width: 130px">压裂施工周期</th>
      <th style="width: 170px">每次异常事件发生概率-桥塞遇阻或提前坐封</th>
      <th>每次异常事件发生概率-射孔枪点火失败</th>
      </thead>
      <tbody>
      <tr>
        <td>优化段数前(常规压裂)</td>
        <td id="td4-before-压裂段数">25</td>
        <td id="td4-before-压裂费用">593</td>
        <td id="td4-before-桥射联作费用">192</td>
        <td id="td4-before-连油钻塞费用">74</td>
        <td id="td4-before-桥塞费用">26</td>
        <td id="td4-before-压裂施工周期">10.0</td>
        <td id="td4-before-桥塞遇阻或提前坐封概率">21</td>
        <td id="td4-before-射孔枪点火失败概率">21</td>
      </tr>
      <tr>
        <td>优化段数后(零桥塞压裂TM)</td>
        <td id="td4-after-压裂段数">13</td>
        <td id="td4-after-压裂费用">308</td>
        <td id="td4-after-桥射联作费用">96</td>
        <td id="td4-after-连油钻塞费用">37</td>
        <td id="td4-after-桥塞费用">13</td>
        <td id="td4-after-压裂施工周期">8.5</td>
        <td id="td4-after-桥塞遇阻或提前坐封概率">11</td>
        <td id="td4-after-射孔枪点火失败概率">11</td>
      </tr>
      </tbody>
    </table>
  </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.2/FileSaver.min.js"></script>
<script>
  const showMsgOk = (text) => (new Notyf({position: {x: 'right', y: 'top'}})).success(text);
  const showMsgErr = (text) => (new Notyf({position: {x: 'right', y: 'top'}})).error(text);
  const toggleTable2 = () => $('#table-2').toggle();
  $("#btn-setting").click(
      () => toggleTable2()
  );
  $("#btn-about-us").click(
      () => window.location.href = "contactuscn.html"
  );
  $("#btn-capture").click(
      () => {
        showMsgOk("正在生成截图请等待...");
        html2canvas(document.querySelector("#capture")).then(canvas => {
          var dataURL = canvas.toDataURL("image/png");
          var data = atob(dataURL.substring("data:image/png;base64,".length)),
              asArray = new Uint8Array(data.length);
          for (var i = 0, len = data.length; i < len; ++i) {
            asArray[i] = data.charCodeAt(i);
          }
          var blob = new Blob([asArray.buffer], {type: "image/png"});
          saveAs(blob, "photo.png");
          showMsgOk("截图已保存");
        });
      }
  );
  $("#btn-calculate").click(
      () => {
        refreshResultTable();
        showMsgOk("计算结果已更新");
      }
  );
  $('.only-num').keyup(function () {
    this.value = this.value.replace(/[^0-9\.]/g,'');
  });
  $('.only-int').keyup(function () {
    this.value = this.value.replace(/[^0-9]/g,'');
  });
  $('.input').change(function () {
    refreshResultTable();
    showMsgOk("计算结果已更新");
  });
  $('.input-num').keypress(function(e) {
    if(e.which == 13) {
      refreshResultTable();
    }
  });


  const FORM_DATA = {
    field_原设计中的压裂段数: 25,
    field_合并缩减_优化后的压裂段数: 15,
    field_压裂车费用_N_1: 0.95,
    field_压裂车费用_N_2: 24,
    field_混砂车费用_N_1: 0.6,
    field_混砂车费用_N_2: 1,
    field_仪表车费用_N_1: 0.3,
    field_仪表车费用_N_2: 1, // static
    field_桥射联作费用_N_1: 8,
    field_桥射联作费用_N_2: 1, // static
    field_连油钻塞费用_N_1: 3.1,
    field_连油钻塞费用_N_2: 1, // static
    field_桥塞费用_N_1: 1.1,
    field_桥塞费用_N_2: 1, // static
    field_压裂施工速度_N_1: 2.5,
    field_压裂施工速度_N_2: 1, // static
    field_桥射联作平均耗时_N_1: 4,
    field_桥射联作平均耗时_N_2: 1, // static
    field_桥塞遇阻或提前坐封概率_N_1: 1,
    field_桥塞遇阻或提前坐封概率_N_2: 1, // static
    field_射孔枪点火失败概率_N_1: 0.1,
    field_射孔枪点火失败概率_N_2: 1, // static
  };
  const CHART_DATA = {
    field_段数减少: 0,
    field_费用减少: 0,
    field_施工时间减少: 0,
    field_桥射联作风险降低: 0,
    beforeOptimized: {
      field_压裂段数: 0,
      field_压裂费用: 0,
      field_桥射联作费用: 0,
      field_连油钻塞费用: 0,
      field_桥塞费用: 0,
      field_压裂施工周期: 0,
      field_桥塞遇阻提前坐封概率: 0,
      field_射孔枪点火失败概率: 0,
    },
    afterOptimized: {
      field_压裂段数: 0,
      field_压裂费用: 0,
      field_桥射联作费用: 0,
      field_连油钻塞费用: 0,
      field_桥塞费用: 0,
      field_压裂施工周期: 0,
      field_桥塞遇阻提前坐封概率: 0,
      field_射孔枪点火失败概率: 0,
    }
  };
  const beforeOptimized = () => Object.values(CHART_DATA.beforeOptimized);
  const afterOptimized = () => Object.values(CHART_DATA.afterOptimized);

  const refreshResultTable = () => {
    // LOAD FORM DATA
    FORM_DATA.field_原设计中的压裂段数 = Number($('#form-data-原设计中的压裂段数').val());
    FORM_DATA.field_合并缩减_优化后的压裂段数 = Number($('#form-data-合并缩减-优化后的压裂段数').val());
    FORM_DATA.field_压裂车费用_N_1 = Number($('#form-data-压裂车费用-N-1').val());
    FORM_DATA.field_压裂车费用_N_2 = Number($('#form-data-压裂车费用-N-2').val());
    FORM_DATA.field_混砂车费用_N_1 = Number($('#form-data-混砂车费用-N-1').val());
    FORM_DATA.field_混砂车费用_N_2 = Number($('#form-data-混砂车费用-N-2').val());
    FORM_DATA.field_仪表车费用_N_1 = Number($('#form-data-仪表车费用-N-1').val());
    FORM_DATA.field_桥射联作费用_N_1 = Number($('#form-data-桥射联作费用-N-1').val());
    FORM_DATA.field_连油钻塞费用_N_1 = Number($('#form-data-连油钻塞费用-N-1').val());
    FORM_DATA.field_桥塞费用_N_1 = Number($('#form-data-桥塞费用-N-1').val());
    FORM_DATA.field_压裂施工速度_N_1 = Number($('#form-data-压裂施工速度-N-1').val());
    FORM_DATA.field_桥射联作平均耗时_N_1 = Number($('#form-data-桥射联作平均耗时-N-1').val());
    FORM_DATA.field_桥塞遇阻或提前坐封概率_N_1 = Number($('#form-data-桥塞遇阻或提前坐封概率-N-1').val());
    FORM_DATA.field_射孔枪点火失败概率_N_1 = Number($('#form-data-射孔枪点火失败概率-N-1').val());
    // LOAD CHART DATA
    CHART_DATA.beforeOptimized.field_压裂段数 = FORM_DATA.field_原设计中的压裂段数;
    CHART_DATA.afterOptimized.field_压裂段数 = FORM_DATA.field_合并缩减_优化后的压裂段数;
    // TODO: replace mock data
    const getRadN = () => { return Math.floor(Math.random() * 100) + 1};
    CHART_DATA.field_段数减少 = FORM_DATA.field_原设计中的压裂段数 - FORM_DATA.field_合并缩减_优化后的压裂段数;
    CHART_DATA.field_费用减少 = getRadN();
    CHART_DATA.field_施工时间减少 = getRadN();
    CHART_DATA.field_桥射联作风险降低 = getRadN();
    const _单段压裂费用 = (FORM_DATA.field_压裂车费用_N_1 * FORM_DATA.field_压裂车费用_N_2) + (FORM_DATA.field_混砂车费用_N_1 * FORM_DATA.field_混砂车费用_N_2) + (FORM_DATA.field_仪表车费用_N_1)
    CHART_DATA.beforeOptimized.field_压裂费用 = Math.round(_单段压裂费用 * FORM_DATA.field_原设计中的压裂段数);
    CHART_DATA.afterOptimized.field_压裂费用 = Math.round(_单段压裂费用 * FORM_DATA.field_合并缩减_优化后的压裂段数);

    CHART_DATA.beforeOptimized.field_桥射联作费用 = Math.round(FORM_DATA.field_桥射联作费用_N_1 * (FORM_DATA.field_原设计中的压裂段数 - 1));
    CHART_DATA.afterOptimized.field_桥射联作费用 =  Math.round(FORM_DATA.field_桥射联作费用_N_1 * (FORM_DATA.field_合并缩减_优化后的压裂段数 - 1));

    CHART_DATA.beforeOptimized.field_连油钻塞费用= getRadN();
    CHART_DATA.beforeOptimized.field_桥塞费用= getRadN();
    CHART_DATA.beforeOptimized.field_压裂施工周期= getRadN();
    CHART_DATA.beforeOptimized.field_桥塞遇阻提前坐封概率= getRadN();
    CHART_DATA.beforeOptimized.field_射孔枪点火失败概率= getRadN();
    CHART_DATA.afterOptimized.field_连油钻塞费用= getRadN();
    CHART_DATA.afterOptimized.field_桥塞费用= getRadN();
    CHART_DATA.afterOptimized.field_压裂施工周期= getRadN();
    CHART_DATA.afterOptimized.field_桥塞遇阻提前坐封概率= getRadN();
    CHART_DATA.afterOptimized.field_射孔枪点火失败概率= getRadN();
    // LOAD TABLE
    $('#td4-before-压裂段数').text(CHART_DATA.beforeOptimized.field_压裂段数);
    $('#td4-before-压裂费用').text(CHART_DATA.beforeOptimized.field_压裂费用);
    $('#td4-before-桥射联作费用').text(CHART_DATA.beforeOptimized.field_桥射联作费用);
    $('#td4-before-连油钻塞费用').text(CHART_DATA.beforeOptimized.field_连油钻塞费用);
    $('#td4-before-桥塞费用').text(CHART_DATA.beforeOptimized.field_桥塞费用);
    $('#td4-before-压裂施工周期').text(CHART_DATA.beforeOptimized.field_压裂施工周期);
    $('#td4-before-桥塞遇阻或提前坐封概率').text(CHART_DATA.beforeOptimized.field_桥塞遇阻提前坐封概率);
    $('#td4-before-射孔枪点火失败概率').text(CHART_DATA.beforeOptimized.field_射孔枪点火失败概率);
    $('#td4-after-压裂段数').text(CHART_DATA.afterOptimized.field_压裂段数);
    $('#td4-after-压裂费用').text(CHART_DATA.afterOptimized.field_压裂费用);
    $('#td4-after-桥射联作费用').text(CHART_DATA.afterOptimized.field_桥射联作费用);
    $('#td4-after-连油钻塞费用').text(CHART_DATA.afterOptimized.field_连油钻塞费用);
    $('#td4-after-桥塞费用').text(CHART_DATA.afterOptimized.field_桥塞费用);
    $('#td4-after-压裂施工周期').text(CHART_DATA.afterOptimized.field_压裂施工周期);
    $('#td4-after-桥塞遇阻或提前坐封概率').text(CHART_DATA.afterOptimized.field_桥塞遇阻提前坐封概率);
    $('#td4-after-射孔枪点火失败概率').text(CHART_DATA.afterOptimized.field_射孔枪点火失败概率);
    $('#td3-段数减少').text(CHART_DATA.field_段数减少);
    $('#td3-费用减少').text(CHART_DATA.field_费用减少);
    $('#td3-施工时间减少').text(CHART_DATA.field_施工时间减少);
    $('#td3-桥射联作风险降低').text(CHART_DATA.field_桥射联作风险降低);
    drawBarChart()
  };

  const drawBarChart = () => {
    const cht = echarts.init(document.getElementById('calculatorPie'));
    const labelFormatter = (params) => {
      if (params.name === "压裂段数") {
        return params.value + '段'
      }
      if (params.name === "压裂施工周期") {
        return params.value + '天'
      }
      if (params.name === '桥塞遇阻或提前坐封概率' || params.name === '射孔枪点火失败概率') {
        return params.value + '%'
      }
      return params.value + '万元'
    };
    const option = {
      grid: {bottom: '0', right: '0'},
      legend: {
        data: ['优化段数前(常规压裂)', '优化段数后(零桥塞压裂TM)'],
        orient: 'vertical',
        top: 0,
        right: 50,
      },
      xAxis: {
        show: false,
        type: 'category',
        nameTextStyle: {fontSize: 3},
        nameGap: 3,
        axisLabel: {interval: 0},
        data: ['压裂段数', '压裂费用', '桥射联作费用', '连油钻塞费用', '桥塞费用', '压裂施工周期', '桥塞遇阻或提前坐封概率', '射孔枪点火失败概率']
      },
      yAxis: {show: false},
      series: [
        {
          name: '优化段数前(常规压裂)',
          type: 'bar',
          data: beforeOptimized(),
          barGap: '5%',
          barWidth: '25%',
          itemStyle: {color: '#747474'},
          label: {normal: {show: true, position: 'top', formatter: labelFormatter}},
        },
        {
          name: '优化段数后(零桥塞压裂TM)',
          type: 'bar',
          data: afterOptimized(),
          barGap: '5%',
          barWidth: '25%',
          itemStyle: {color: '#0057a7'},
          label: {normal: {show: true, position: 'top', formatter: labelFormatter}},
        },
      ]
    };
    cht.setOption(option);
  };
  refreshResultTable();
</script>
<style>
  .button-vertical-center {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .input {
    animation-name: unset;
    animation-fill-mode: unset;
    animation-delay: unset;
    visibility: unset;
  }
</style>
